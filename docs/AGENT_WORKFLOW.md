# Agent Development Workflow

## Overview
This document outlines the mandatory validation workflow for all agents working with the expo-audio-stream codebase.

## Validation System

### Development Validation (Primary)
**When to use**: For all feature development and testing
**Command**: `yarn agent:dev <feature> [platform]`
**Duration**: < 2 minutes
**Purpose**: Validate that functionality works correctly
**Requirement**: MANDATORY for all agent work

### Full Validation (Optional)
**When to use**: Manual choice or CI pipeline
**Command**: `yarn agent:full [platform]`
**Duration**: 5-10 minutes
**Purpose**: Comprehensive testing (optional)

## Quick Start

```bash
# Navigate to playground app
cd apps/playground

# Setup devices (first time only)
yarn agent:setup

# Validate your feature development (REQUIRED)
yarn agent:dev compression android

# Clean up development artifacts
yarn agent:cleanup

# Optional: Run comprehensive testing if desired
yarn agent:full
```

## Development Mode Details

### Supported Features
| Feature | Description | Deep Link Parameters |
|---------|-------------|---------------------|
| `basic` | Standard recording workflow | `sampleRate=44100&channels=1` |
| `compression` | Compressed audio output | `compressedOutput=true&compressedFormat=aac` |
| `high-frequency` | High-frequency dual timing measurement | `intervalAnalysis=25&interval=10&measurePrecision=true&sampleRate=48000` |
| `multi-channel` | Stereo recording | `channels=2&sampleRate=44100` |
| `pause-resume` | Pause/resume workflow | `testPauseResume=true` |
| `error-handling` | Error scenarios | `sampleRate=999999&testErrors=true` |

### Platform Options
- `android` (default) - Test on Android device/emulator
- `ios` - Test on iOS simulator (macOS only)
- `both` - Test on both platforms sequentially

### Examples

```bash
# Test compression feature on Android
yarn agent:dev compression android

# Test high-frequency recording on iOS  
yarn agent:dev high-frequency ios

# Test basic workflow on both platforms
yarn agent:dev basic both

# Custom parameters for specific testing
yarn agent:dev custom android "sampleRate=16000&channels=1&interval=50"
```

## Optional Full Validation Details

### What It Runs (Optional)
1. **TypeScript Compilation**: Full type checking
2. **Package Build**: expo-audio-studio build verification
3. **Unit Tests**: Android (25/25) + iOS (66/66)
4. **Integration Tests**: Android instrumented tests (11/11)
5. **E2E Tests**: Recording + Import + Screenshot workflows
6. **Cross-Platform**: Both iOS and Android validation

### When to Use
- **Manual Choice**: When you want comprehensive testing
- **CI Pipeline**: Automated comprehensive validation
- **Before Major Releases**: Additional confidence
- **NOT REQUIRED**: For agent completion

### Success Criteria (If Run)
- All 102 tests pass
- No TypeScript compilation errors
- No test failures or timeouts
- Screenshots match expected output

## Screenshot Management

### Development Screenshots
- **Location**: `screenshots/dev-iteration/`
- **Auto-generated**: During `yarn agent:dev` 
- **Auto-cleaned**: Before `yarn agent:final`
- **Ignored by git**: Never committed

### Production Screenshots
- **Location**: `screenshots/production/` and `screenshots/v0.12.1/`
- **Purpose**: App store submissions and regression testing
- **Committed**: Version controlled

## Log Management

### Development Validation Logs
**Location**: `apps/playground/logs/agent-validation/`
**Generated by**: `yarn agent:dev <feature> <platform>`
**Purpose**: Detailed failure analysis and agent feedback
**Retention**: Automatically deleted on success, preserved on failure

Example log path:
```
logs/agent-validation/basic-android-20250607-182502.log
```

### Full Validation Logs  
**Location**: `apps/playground/logs/full-validation/`
**Generated by**: `yarn agent:full <platform>`
**Content**: Unit tests, integration tests, E2E test results

Example log paths:
```
logs/full-validation/android-unit-tests-20250607-183045.log
logs/full-validation/android-integration-tests-20250607-183045.log
logs/full-validation/android-e2e-record-20250607-183045.log
```

### Log Features
- **Project-relative paths**: No permission issues (unlike `/tmp`)
- **Git-ignored**: Never committed to repository
- **Detailed feedback**: Specific test failures, error messages, actionable guidance
- **Automatic cleanup**: Success logs deleted, failure logs preserved
- **Manual cleanup**: Use `yarn agent:cleanup` to remove all development artifacts

### Agent Integration
The improved logging system provides agents with:
- ✅ **Specific test failures** with line numbers and error messages
- ✅ **Actionable guidance** for common failure patterns  
- ✅ **Complete stack traces** for debugging
- ✅ **Performance metrics** and timing data
- ✅ **No silent failures** - all output captured and analyzed

## Device Setup

### Android Setup
```bash
# Check device status
adb devices

# If no devices, start emulator or connect device
# Then verify:
yarn agent:setup
```

### iOS Setup
```bash
# Check simulator status  
xcrun simctl list devices | grep iPhone

# Start simulator if needed
yarn setup:ios-simulator

# Verify setup
yarn agent:setup
```

## Error Handling

### Common Issues

**"No Android device detected"**
```bash
# Start emulator or connect device
adb devices
# Should show: device_id    device
```

**"No iOS simulator running"**
```bash
# Start simulator
yarn setup:ios-simulator
# Or manually: xcrun simctl boot "iPhone 15"
```

**"TypeScript compilation failed"**
```bash
# Fix TypeScript errors first
yarn typecheck
# Then retry validation
```

**"Build failed"**
```bash
# Clean and rebuild
cd ../../packages/expo-audio-studio
yarn clean && yarn build
cd ../../apps/playground
```

## Troubleshooting

### Development Mode Failures
1. Check deep link parameters are valid
2. Verify device/simulator is responsive
3. Check app is properly launched
4. Review screenshot output for visual issues

### Final Validation Failures  
1. Run individual test commands to isolate issue
2. Check all devices are properly connected
3. Verify no other apps using audio resources
4. Review full error logs for specific failures

## Agent Responsibilities

### Required for All Work
- ✅ Always use `yarn agent:dev` for validating features
- ✅ Test on at least one platform (usually Android)
- ✅ Fix issues immediately when found
- ✅ Use appropriate feature parameters for testing
- ✅ Include actual command output in responses

### Optional Activities
- ✅ Run `yarn agent:full` if comprehensive testing desired
- ✅ Test on both platforms if needed for the feature
- ✅ Review and clean up any development screenshots

### Never Do
- ❌ Skip development validation and claim work is complete
- ❌ Simulate test results instead of running real tests
- ❌ Commit development screenshots
- ❌ Bypass validation for any changes

## Integration with agent-validation.tsx

The development mode uses the existing `agent-validation.tsx` page which:
- Accepts deep link parameters for configuration
- Displays real-time recording status and results
- Shows configuration, events, and errors on-screen
- Enables Detox E2E tests to validate UI state
- Provides immediate feedback on API behavior

This approach ensures agents test the actual expo-audio-studio API behavior rather than mocked interfaces. 